/*! 13kgame - v0.0.1 - 2012-09-13
* Copyright (c) 2012 mitermayer reis; Licensed MIT */
(function(e){"use strict";var t=function(){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){e.setTimeout(t,1e3/60)}}();e.requestAnimFrame=t;var n=function(){var e=document.getElementsByTagName("canvas")[0],t=e.getContext("2d"),r=Math.PI,i=r/180;return{canvas:e,ctx:t,cleanCanvas:function(){e.width=e.width},utils:{getGridSize:function(e,t){var n=t[0]>t[1]?t[0]:t[1];return Math.floor(n/Math.ceil(n/Math.floor(Math.sqrt(t[0]*t[1]/e))))},gcd:function(e,t){var r=n.utils.gcd,i;return t===0?i=e:i=r(t,e%t),i},lcd:function(e,t){return e*t/n.utils.gcd(e,t)},getRandomColor:function(){var e=[],t=[255,255,255];for(var n=0;n<3;n++)e[n]=Math.round((Math.floor(Math.random()*256)+t[n])/2);return"rgb("+e[0]+","+e[1]+","+e[2]+")"},getRandomPoints:function(e,t,n){var r=Math.floor(Math.cos(t*i)*n),s=Math.floor(Math.sin(t*i)*n);return r=e[0]+r,s=e[1]+s,[r,s]},getRandomPolygonPoints:function(e,t,r){var i=[],s=[];for(var o=0;o<r;o++)i[i.length]=Math.floor(Math.random()*361);i.sort(function(e,t){return e-t});for(var u=0,a=i.length;u<a;u++)s[s.length]=n.utils.getRandomPoints(e,i[u],t);return s},getFullScreen:function(){},matchProbability:function(e){var t=e,n=Math.random,r=Math.ceil;return r(n()*r(100/t))===r(100/t)},getInt:function(e){return parseInt(e,10)}}}}(),r=function(){var e=null,t=null;this.grid=[],this.childNodes={},this.getCoordsFromCell=function(t,n){return[t*e,n*e]},this.getCellFromCoords=function(t,n){return[Math.floor(n/e),Math.floor(t/e)]},this.setboundSize=function(e){t=e},this.setgridSize=function(t){e=t},this.resetGrid=function(){this.generateGrid(e,t)}};r.prototype={generateGrid:function(e,t){var n=[],r=Math.floor(t[0]/e),i=Math.floor(t[1]/e);for(var s=0;s<i;s++){n[s]=[];for(var o=0;o<r;o++)n[s][o]={}}this.grid=n},addObject:function(e,t,n){if(typeof e.id=="undefined")throw new Error("WorldGrid.addObject: Object must have an ID.");e.id in this.childNodes?this.updateObject(e.id,t,n):(this.childNodes[e.id]={row:t,col:n,node:e},this.grid[t][n][e.id]=this.getObject(e.id))},updateObject:function(e,t,n){this.childNodes[e].col=n,this.childNodes[e].row=t,this.removeObject(e),this.grid[t][n][e]=this.getObject(e)},removeObject:function(e,t){var n=this.childNodes[e];delete this.grid[n.row][n.col][e],t&&delete this.childNodes[e]},getObject:function(e){return this.childNodes[e].node},getCell:function(e,t){var n=!1;if(typeof this.grid[e]!="undefined"&&typeof this.grid[e][t]!="undefined"){n=[];var r=this.grid[e][t];for(var i in r)r.hasOwnProperty(i)&&(n[n.length]=i)}return n}};var i=function(){var e=!1,t=!1,r=0,i=[0,0];this.matchId=!1,this.show=function(){t=!0},this.hide=function(){t=!1},this.updateSize=function(e){r=e},this.getSize=function(){return r},this.updateShape=function(t){e=t},this.updatePosition=function(e){i=e},this.draw=function(){t&&e&&n.ctx.drawImage(e,i[0],i[1],r,r)}},s=function(){var e=[],r={},i="ID_",s=0;this.running=!1,this.getPoolSum=function(){return e.length},this.addShape=function(t,n){return t.id=t.id||i+ ++s,n?e.splice(n,1,t.id):e[e.length]=t.id,r[t.id]=t,t.id},this.removeShape=function(t){var n=!1,i=t;if(i){for(var s=e.length;s>=0;s--)if(e[s]===r[i].id){n=r[e[s]],e.splice(s,1);break}}else n=r[e.pop()];return n},this.mainloop=function(){n.cleanCanvas();for(var t=0,i=e.length;t<i;t++)r[e[t]].draw()},this.stopMainLoop=function(){this.running=!1},this.start=function(){this.running=!0;var e=this;(function n(){t(n),e.running&&e.mainloop()})()}},o=function(e){this.color=e.color||n.utils.getRandomColor(),this.position=e.position||[0,0],this.size=e.size,this.shape=null,this.cachedShape=null,this.visible=!0,this.generateShape()};o.prototype={clone:function(){var e={},t;for(t in this)e[t]=this[t];return e},generateShape:function(){var e=document.createElement("canvas"),t=e.getContext("2d"),r=this.size,i=r/2;this.shape===null&&(this.shape=n.utils.getRandomPolygonPoints([i,i],i,Math.floor(Math.random()*6)+5)),e.height=r,e.width=r,t.fillStyle=this.color,t.strokeStyle=this.color,t.beginPath(),t.moveTo(this.shape[0][0],this.shape[0][1]);for(var s=1,o=this.shape.length;s<o;s++)t.lineTo(this.shape[s][0],this.shape[s][1]);t.closePath(),t.stroke(),t.fill(),this.cachedShape=e},draw:function(){this.visible&&n.ctx.drawImage(this.cachedShape,this.position[0],this.position[1],this.size,this.size)}};var u=function(){var t=document.getElementById("game"),a=n.canvas,f=n.ctx,l={level:document.getElementById("level"),score:document.getElementById("score"),timer:document.getElementById("timer")},c={canvasSize:[t.offsetWidth,t.offsetHeight],numOfItems:2,itemSize:null,whiteSpace:.3,scorePoints:9,levelIncrementShape:2,gameTimer:30,dropColor:"#555"},h={},p,d,v=new r,m=new s,g=new i,y=function(e,t){return n.utils.getGridSize(e*2*(1+c.whiteSpace),t)},b=function(e){var t=e.clientX-a.offsetLeft,n=e.clientY-a.offsetTop;return[t,n]},w=function(e,t){var n=null,r,i,s,o,u,a;while(n===null)r=t[0]-e,i=t[1]-e,s=Math.round(Math.random()*r),o=Math.round(Math.random()*i),u=v.getCellFromCoords(s,o),a=v.getCell(u[0],u[1]),n=a.length===0?!0:null;return u},E=function(e,t){m.addShape(e),v.addObject(e,t[0],t[1]),e.position=v.getCoordsFromCell(t[1],t[0])},S=function(e){var t=e.bounds,n=e.size,r=e.num,i,s;for(var u=0;u<r;u++)i=new o({size:n}),s=i.clone(),E(i,w(n,t)),E(s,w(n,t)),s.matchId=i.id,s.color=c.dropColor,s.generateShape()};return a.width=c.canvasSize[0],a.height=c.canvasSize[1],a.addEventListener("mousedown",function(e){e.preventDefault(),e.stopPropagation();if(!g.cachedShape){var t=b(e),n=v.getCellFromCoords(t[0],t[1]),r=v.getCell(n[0],n[1]),i=r&&r.length?v.getObject(r[0]):!1;i&&!i.matchId&&i.visible&&(i.visible=!1,g.matchId=i.id,g.show(),g.updateSize(i.size),g.updatePosition([t[0]-i.size/2,t[1]-i.size/2]),g.updateShape(i.cachedShape))}a.dragging=!0},!1),a.addEventListener("mouseup",function(e){e.preventDefault(),e.stopPropagation();var t=b(e),n=v.getCellFromCoords(t[0],t[1]),r=v.getCell(n[0],n[1]),i=r&&r.length?v.getObject(r[0]):!1;i&&i.matchId&&i.matchId===g.matchId?(i.visible=!1,h.Shapes+=1,h.currentShapes+=1,h.score+=c.scorePoints,l.score.innerHTML=h.score,h.currentShapes===h.TotalLevelShapes&&d.levelUp()):g.matchId&&(v.getObject(g.matchId).visible=!0),g.hide(),g.matchId=!1,a.dragging=!1},!1),a.addEventListener("mousemove",function(e){if(a.dragging){var t=g.getSize(),n=e.clientX-a.offsetLeft-t/2,r=e.clientY-a.offsetTop-t/2;g.updatePosition([n,r])}},!1),d={init:function(){h={Shapes:0,score:0,level:1,currentShapes:0,TotalLevelShapes:c.numOfItems},d.start(),p=e.setInterval(function(){var e=l.timer,t=n.utils.getInt(e.innerHTML)-1;e.innerHTML=t,t<=0&&(clearTimeout(p),p=null,d.gameOver())},1e3),m.start()},getStats:function(){return h},start:function(e){var t=e||{},n=t.numOfItems||c.numOfItems,r=t.gridSize||c.canvasSize,i=y(n,r),s=[];l.timer.innerHTML=c.gameTimer,g.id&&m.removeShape(g.id);if(m.getPoolSum()!==0)while(m.getPoolSum())s.push(m.removeShape());v.setboundSize(r),v.setgridSize(i),v.resetGrid();if(s.length)for(var o=0,u=s.length,a=2*n;o<a&&o<u;o++)s[o].visible=!0,s[o].size=i,E(s[o],w(i,r));var f=s.length/2,h=n-f;h>0&&S({bounds:r,size:i,num:h}),m.addShape(g)},newGame:function(){window.location=""},gameOver:function(){var t=this.getStats();m.stopMainLoop(),e.confirm("Unfortunetely your time has run out.\nLevel: "+t.level+"\nScore: "+t.score+"\n Would you like to play again ?")&&u.newGame()},levelUp:function(){var e=c,t=h;t.currentShapes=0,t.level+=1,t.TotalLevelShapes+=e.levelIncrementShape,l.level.innerHTML=t.level,l.timer.innerHTML=c.gameTimer,d.start({numOfItems:t.TotalLevelShapes,gridSize:c.canvasSize})}},d}();e.shapeBlocks=u,e.onload=u.init})(this);